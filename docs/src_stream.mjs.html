<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/stream.mjs - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700">
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-stream.LtsvToJsonStream.html">LtsvToJsonStream</a></li></ul><h3>Modules</h3><ul><li><a href="module-ltsv.html">ltsv</a></li><li><a href="module-formatter.html">formatter</a><ul class='methods'><li data-type='method'><a href="module-formatter.html#.format">format</a></li><li data-type='method'><a href="module-formatter.html#.formatStrict">formatStrict</a></li></ul></li><li><a href="module-parser.html">parser</a><ul class='methods'><li data-type='method'><a href="module-parser.html#.parse">parse</a></li><li data-type='method'><a href="module-parser.html#.parseLine">parseLine</a></li><li data-type='method'><a href="module-parser.html#.parseStrict">parseStrict</a></li><li data-type='method'><a href="module-parser.html#.parseLineStrict">parseLineStrict</a></li></ul></li><li><a href="module-stream.html">stream</a><ul class='methods'><li data-type='method'><a href="module-stream.html#.createLtsvToJsonStream">createLtsvToJsonStream</a></li></ul></li><li><a href="module-validator.html">validator</a><ul class='methods'><li data-type='method'><a href="module-validator.html#.isValidLabel">isValidLabel</a></li><li data-type='method'><a href="module-validator.html#.isValidValue">isValidValue</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/stream.mjs</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file LTSV to JSON transform stream.
 * @module stream
 */

import { Transform } from 'stream';
import { StringDecoder } from 'string_decoder';

import { parseLine, parseLineStrict } from './parser.mjs';

/**
 * LTSV to JSON transform stream.
 */
export class LtsvToJsonStream extends Transform {
  /**
   * constructor.
   *
   * @param {Object} options
   * @param {string} options.encoding
   * @param {boolean} options.objectMode
   * @param {boolean} options.strict
   */
  constructor(options = {}) {
    super({
      ...options,
      decodeStrings: true,
      objectMode: true
    });

    const { encoding = 'utf8', objectMode = false, strict = false } = options;

    this.objectMode = objectMode;
    this.parse = strict ? parseLineStrict : parseLine;

    this.buffer = '';
    this.decoder = new StringDecoder(encoding);
  }

  /**
   * transform and push to stream.
   *
   * @private
   * @param {string} text
   * @param {boolean} isFlush
   * @param {Function} callback
   */
  _push(text, isFlush, callback) {
    let next = 0;
    let last = 0;
    let error = null;

    // eslint-disable-next-line no-constant-condition
    while (true) {
      let index = text.indexOf('\n', next);

      if (index === -1) {
        if (isFlush &amp;&amp; next &lt; text.length) {
          // NOTE: subtract 1 from text.length,
          // NOTE: because add 1 to index when slice.
          index = text.length - 1;
        } else {
          break;
        }
      }

      // NOTE: include `\n`.
      // NOTE: foo:foo\tbar:bar\nfoo:foo\tbar:bar\n
      // NOTE: -----------------|
      const line = text.slice(next, index + 1);

      let record;

      try {
        record = this.parse(line);
      } catch (e) {
        error = e;
      }

      if (error) {
        break;
      }

      const result = this.push(
        this.objectMode ? record : JSON.stringify(record)
      );

      if (result) {
        // NOTE: save next start index.
        // NOTE: foo:foo\tbar:bar\nfoo:foo\tbar:bar\n
        // NOTE: ------------------|
        last = next = index + 1;
      } else {
        break;
      }
    }

    this.buffer = text.slice(last);

    callback(error);
  }

  /**
   * _transform implementation.
   *
   * @private
   * @param {Buffer|string|*} chunk
   * @param {string} encoding
   * @param {Function} callback
   */
  _transform(chunk, encoding, callback) {
    this._push(this.buffer + this.decoder.write(chunk), false, callback);
  }

  /**
   * _flush implementation.
   *
   * @private
   * @param {Function} callback
   */
  _flush(callback) {
    this._push(this.buffer + this.decoder.end(), true, callback);
  }
}

/**
 * create LtsvToJsonStream instance.
 *
 * @param {Object} options
 * @return {LtsvToJsonStream}
 * @see LtsvToJsonStream
 */
export function createLtsvToJsonStream(options) {
  return new LtsvToJsonStream(options);
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Jan 27 2019 20:11:43 GMT+0900 (GMT+09:00) using the <a href="https://github.com/mochajs/mocha-docdash">@mocha/docdash</a> theme.
</footer>

<script src="scripts/prettify/prettify.js"></script>
<script src="scripts/prettify/lang-css.js"></script>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


    <link type="text/css" rel="stylesheet" href="ltsv.css">
    
</body>
</html>
